<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E.CO PG Run Data Collection Form - MPL</title>
  <link rel="stylesheet" href="styles.css" /> <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  </head>
<body>

<div class="login-container" id="loginContainer">
  <h2>Login</h2>
  <form id="loginForm">
    <div class="input-group">
      <label for="username">Username:</label>
      <input type="text" id="username" name="username" required placeholder="Enter your username">
      <span class="error-message" id="username-error"></span>
    </div>

    <div class="input-group">
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" required placeholder="Enter your password">
      <span class="error-message" id="password-error"></span>
    </div>

    <button type="submit">Login</button>

    <div class="login-message" id="login-status"></div>
  </form>
</div>

<div id="formContainer" style="display: none;">
  <div class="container">
    <h2>E.CO PG Run Data Collection Form-MPL</h2>
    <form id="pgForm" novalidate> <div class="card">
        <label for="ttNumber">TT Number:</label>
        <input type="text" id="ttNumber" name="ttNumber" />
        <span class="error-message" id="ttNumber-error"></span>

        <label for="operatorName">Operator Name:</label>
        <select id="operatorName" name="operatorName">
          <option value="" disabled selected>Select an operator</option>
          <option value="GP">GP</option>
          <option value="BL">BL</option>
          <option value="ROBI">ROBI</option>
        </select>
         <span class="error-message" id="operatorName-error"></span>

        <label for="siteDropdown">Select Site:</label>
        <select id="siteDropdown" name="site"></select>
        <span class="error-message" id="siteDropdown-error"></span>
      </div>

      <div class="card">
        <label for="pgOperatorDropdown">Select PG Operator Name:</label>
        <select id="pgOperatorDropdown" name="pgOperator"></select>
         <span class="error-message" id="pgOperatorDropdown-error"></span>

        <label for="teamLeaderDropdown">Select Team Leader Name:</label>
        <select id="teamLeaderDropdown" name="teamLeader"></select>
         <span class="error-message" id="teamLeaderDropdown-error"></span>
      </div>

      <div class="card">
        <label for="selectOption">Select Option:</label>
        <select id="selectOption" name="selectOption">
          <option value="" disabled selected>Select an option</option>
          <option value="Misscall TT">Misscall TT</option>
          <option value="PG Run">PG Run</option>
        </select>
        <span class="error-message" id="selectOption-error"></span>
      </div>

      <div id="misscallTTFields" style="display: none;">
        <div class="card">
          <label for="siteAttend">Site Attend:</label>
          <select id="siteAttend" name="siteAttend">
            <option value="" disabled selected>Select an option</option>
            <option value="YES">YES</option>
            <option value="NO">NO</option>
          </select>
           <span class="error-message" id="siteAttend-error"></span>
        </div>
        <div id="siteAttendDateTimeField" style="display: none;">
           <div class="card"> <label for="siteAttendDateTime">Site Attend Date & Time:</label>
               <input type="datetime-local" id="siteAttendDateTime" name="siteAttendDateTime" />
               <span class="error-message" id="siteAttendDateTime-error"></span>
           </div>
        </div>
      </div>

      <div id="pgRunFields" style="display: none;">
        <div id="pgEventsContainer">
             </div>
        <button type="button" id="addEventBtn" class="add-button">Add Another Event</button>
      </div>

       <button type="submit">Submit</button>
        <div class="loading">Submitting...</div>
        <div class="success-message">Submission successful!</div>
    </form>
  </div>
  </div>


<div class="footer-info">
  <p>Powered and Developed By<br>
  <strong>Rakibul Islam Ratul</strong><br>
  <small>Sr. Manager, Central Governance, Metal Plus Ltd.</small></p>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
  $(document).ready(function () {
    console.log("Document ready."); // Log document ready

    const MAX_EVENTS = 10; // Set the maximum number of events allowed
    let eventCount = 0; // Counter for dynamic events

    // Helper function to get current date/time inYYYY-MM-DDTHH:MM format
    function getCurrentDateTimeLocal() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Helper function to parse date/time string into a Date object (should work with native datetime-local)
    function parseDateTime(datetimeStr) {
        if (!datetimeStr) {
            console.log("parseDateTime: Received empty string, returning null.");
            return null;
        }
        const date = new Date(datetimeStr);
        if (isNaN(date.getTime())) {
            console.log("parseDateTime: Parsed date is invalid.");
            return null;
        }
        return date;
    }

    // Helper function to display or clear error messages and apply invalid class
    function displayError(fieldId, message) {
        const errorSpan = $(`#${fieldId}-error`);
        const fieldElement = $(`#${fieldId}`);

        if (!fieldElement.length) {
            console.error(`Field element #${fieldId} not found.`);
            if (errorSpan.length) errorSpan.text('');
            return;
        }

        if (!errorSpan.length) {
            console.warn(`Error span not found for field: #${fieldId}-error. This field's errors will not be displayed visually, only invalid class applied.`);
            if (message) {
                fieldElement.addClass('is-invalid');
                 // Special handling for Select2 fields
                if (fieldElement.hasClass('select2-hidden-accessible')) {
                  fieldElement.next('.select2-container').find('.select2-selection--single').addClass('is-invalid');
                }
            } else {
                fieldElement.removeClass('is-invalid');
                if (fieldElement.hasClass('select2-hidden-accessible')) {
                  fieldElement.next('.select2-container').find('.select2-selection--single').removeClass('is-invalid');
                }
            }
            return;
        }

        if (message) {
            errorSpan.text(message);
            fieldElement.addClass('is-invalid');
             if (fieldElement.hasClass('select2-hidden-accessible')) {
               fieldElement.next('.select2-container').find('.select2-selection--single').addClass('is-invalid');
            }
        } else {
            errorSpan.text('');
            fieldElement.removeClass('is-invalid');
             if (fieldElement.hasClass('select2-hidden-accessible')) {
               fieldElement.next('.select2-container').find('.select2-selection--single').removeClass('is-invalid');
            }
        }
    }

    // --- Validation Functions ---

    function validateField(fieldId) {
        const value = $(`#${fieldId}`).val();
        if (!value) {
            displayError(fieldId, 'This field is mandatory.');
            return false;
        } else {
            displayError(fieldId, '');
            return true;
        }
    }

    function validateAllConditionalFields() {
        console.log("Validating all conditional fields...");
        const selectOption = $('#selectOption').val();
        let allValid = true;

        // Validate Misscall TT fields if visible
        if (selectOption === 'Misscall TT' && $('#misscallTTFields').is(':visible')) {
            if (!validateField('siteAttend')) allValid = false;
            const siteAttend = $('#siteAttend').val();
            if (siteAttend === 'YES' && $('#siteAttendDateTimeField').is(':visible')) {
                const siteAttendDateTimeVal = $('#siteAttendDateTime').val();
                if (!siteAttendDateTimeVal) {
                    displayError('siteAttendDateTime', 'Date & Time is mandatory when Site Attend is YES.');
                    allValid = false;
                } else {
                    const siteAttendDateTime = parseDateTime(siteAttendDateTimeVal);
                    const now = new Date();
                    if (!siteAttendDateTime || siteAttendDateTime > now) {
                         displayError('siteAttendDateTime', 'Invalid or future date/time.');
                         allValid = false;
                    } else {
                        displayError('siteAttendDateTime', '');
                    }
                }
            } else {
                 displayError('siteAttendDateTime', ''); // Clear if not required
            }
        } else {
             // Clear Misscall TT errors if section is hidden
            displayError('siteAttend', '');
            displayError('siteAttendDateTime', '');
        }


        // Validate PG Run fields if visible
        if (selectOption === 'PG Run' && $('#pgRunFields').is(':visible')) {
             console.log("Validating PG Run fields...");
            // Get all current event cards
            const eventCards = $('#pgEventsContainer').children('.event-card');
            let previousEventStop = null; // To track the stop time of the previous valid event

            if (eventCards.length === 0) {
                 // If PG Run is selected but no event cards exist (shouldn't happen if 1st is added on select),
                 // consider it invalid or handle appropriately.
                 // For now, assuming at least one event is always present if PG Run is selected.
                 // If you allow 0 events, adjust validation.
                 console.warn("PG Run selected but no event cards found.");
                 // Decide if this state is valid or not. Let's assume at least one event must be attempted.
                 // If at least one event is mandatory, you'd set allValid = false here or ensure the first event is added/validated.
            }

            eventCards.each(function(index) {
                const eventNumber = index + 1;
                const pgStartId = `pgStart${eventNumber}`;
                const pgStopId = `pgStop${eventNumber}`;

                const pgStartVal = $(`#${pgStartId}`).val();
                const pgStopVal = $(`#${pgStopId}`).val();

                const pgStart = parseDateTime(pgStartVal);
                const pgStop = parseDateTime(pgStopVal);
                 const now = new Date();


                // Check if the current event pair has any data
                if (pgStartVal || pgStopVal) {
                     console.log(`Validating Event ${eventNumber}: Start=${pgStartVal}, Stop=${pgStopVal}`);
                    // If either field has data, BOTH are mandatory
                    if (!pgStartVal) {
                        displayError(pgStartId, 'Mandatory if providing Stop time.');
                        allValid = false;
                    } else {
                         displayError(pgStartId, ''); // Clear error if filled
                    }
                    if (!pgStopVal) {
                        displayError(pgStopId, 'Mandatory if providing Start time.');
                        allValid = false;
                    } else {
                         displayError(pgStopId, ''); // Clear error if filled
                    }

                    // If both fields have data, perform date/time comparisons
                    if (pgStart && pgStop) {
                         // Validate Start < Stop
                         if (pgStop <= pgStart) {
                             displayError(pgStopId, 'Must be after Start time.');
                             allValid = false;
                         } else {
                              displayError(pgStopId, ''); // Clear error if valid
                         }

                         // Validate not in future
                         if (pgStart > now) {
                             displayError(pgStartId, 'Future date/time not allowed.');
                             allValid = false;
                         } else {
                              // Don't clear if another error is present
                             if ($(`#${pgStartId}-error`).text() === 'Future date/time not allowed.') displayError(pgStartId, '');
                         }
                         if (pgStop > now) {
                              displayError(pgStopId, 'Future date/time not allowed.');
                              allValid = false;
                         } else {
                              // Don't clear if another error is present
                             if ($(`#${pgStopId}-error`).text() === 'Future date/time not allowed.') displayError(pgStopId, '');
                         }


                         // Validate Start time is after previous event's Stop time (if previous event exists and was valid)
                         if (previousEventStop && pgStart <= previousEventStop) {
                             displayError(pgStartId, `Must be after Event ${index}'s Stop time.`);
                             allValid = false;
                         } else {
                             // Don't clear if another error is present
                              const previousEventError = `Must be after Event ${index}'s Stop time.`;
                             if ($(`#${pgStartId}-error`).text() === previousEventError) displayError(pgStartId, '');
                         }

                        // If this event pair is valid, update previousEventStop for the next iteration
                         if (allValid && pgStart && pgStop && pgStop > pgStart && pgStop <= now && (!previousEventStop || pgStart > previousEventStop)) {
                             previousEventStop = pgStop;
                              console.log(`Event ${eventNumber} is valid. Setting previousEventStop to ${previousEventStop}`);
                         } else {
                              console.log(`Event ${eventNumber} has validation issues or is not sequentially valid.`);
                              // If the current event is invalid or out of sequence, break the sequence for subsequent validations
                              previousEventStop = null;
                         }

                    } else if (pgStartVal || pgStopVal) {
                         // If one field is filled but the other is not, it's an incomplete pair (already handled above)
                         allValid = false; // Ensure overall validity is false
                    } else {
                         // If neither field has data, this event is empty and valid (no error to display)
                          displayError(pgStartId, '');
                          displayError(pgStopId, '');
                         console.log(`Event ${eventNumber} is empty.`);
                          // If an event is completely empty, it breaks the sequence for the next event
                          previousEventStop = null;
                    }
                } else {
                     // If neither field has data, this event is empty and valid (no error to display)
                      displayError(pgStartId, '');
                      displayError(pgStopId, '');
                     console.log(`Event ${eventNumber} is empty.`);
                      // If an event is completely empty, it breaks the sequence for the next event
                      previousEventStop = null;
                }
            });

             // After iterating through all events, check if at least the first event was filled if PG Run is selected
            if (eventCards.length > 0) {
                 const firstEventStartVal = $(`#pgStart1`).val();
                 const firstEventStopVal = $(`#pgStop1`).val();
                 if (!firstEventStartVal || !firstEventStopVal) {
                      // If PG Run is selected, the first event is mandatory.
                      // The individual field validation already handles this, but this is a final check.
                      // No need to set allValid = false again if the individual checks already did it.
                 }
            } else {
                 // This state shouldn't be reachable if initializeForm correctly adds the first event.
                 // If it were possible to have 0 events when PG Run is selected, you'd handle that validation here.
                 console.warn("No event cards found for PG Run validation check.");
                 // If 0 events for PG Run is invalid: allValid = false;
            }


        } else {
             // Clear PG Run errors if section is hidden
             $('#pgEventsContainer').children('.event-card').each(function() {
                 const eventNumber = $(this).index() + 1;
                 displayError(`pgStart${eventNumber}`, '');
                 displayError(`pgStop${eventNumber}`, '');
             });
        }


        console.log("Overall conditional validation result:", allValid);
        return allValid;
    }


     // --- Dynamic Event Handling ---

     function addEventField(eventNumber) {
         const nowFormatted = getCurrentDateTimeLocal();
         const eventCardHtml = `
            <div class="event-card" data-event-number="${eventNumber}">
              <h3>${eventNumber}nd Event</h3> <label for="pgStart${eventNumber}">PG Start Date & Time:</label>
               <input type="datetime-local" id="pgStart${eventNumber}" name="pgStart${eventNumber}" max="${nowFormatted}" />
               <span class="error-message" id="pgStart${eventNumber}-error"></span>
              <label for="pgStop${eventNumber}">PG Stop Date & Time:</label>
               <input type="datetime-local" id="pgStop${eventNumber}" name="pgStop${eventNumber}" max="${nowFormatted}" />
               <span class="error-message" id="pgStop${eventNumber}-error"></span>
               ${eventNumber > 1 ? '<button type="button" class="remove-button">Remove Event</button>' : ''}
            </div>
          `;
         $('#pgEventsContainer').append(eventCardHtml);
         eventCount++; // Increment the counter

         // Update the heading text (e.g., 1st Event, 2nd Event)
         const eventCard = $('#pgEventsContainer').children().last();
         const suffix = (eventNumber === 1) ? 'st' : (eventNumber === 2) ? 'nd' : (eventNumber === 3) ? 'rd' : 'th';
         eventCard.find('h3').text(`${eventNumber}${suffix} Event`);

         // Attach event listeners for validation to the new inputs
         $(`#pgStart${eventNumber}, #pgStop${eventNumber}`).on('change blur', validateAllConditionalFields);

         // Attach listener for the remove button
         if (eventNumber > 1) {
              eventCard.find('.remove-button').on('click', function() {
                  $(this).closest('.event-card').remove();
                  eventCount--; // Decrement the counter
                  updateEventNumbers(); // Update headings and IDs after removal
                   validateAllConditionalFields(); // Re-validate after removal
              });
         }

         // Manage "Add Event" button visibility
         if (eventCount >= MAX_EVENTS) {
             $('#addEventBtn').hide();
         } else {
             $('#addEventBtn').show(); // Ensure it's shown if under limit
         }
          console.log(`Added Event ${eventNumber}. Total events: ${eventCount}`);
     }

     // Function to update event numbers and IDs after removal
     function updateEventNumbers() {
          $('#pgEventsContainer').children('.event-card').each(function(index) {
              const eventNumber = index + 1;
              const suffix = (eventNumber === 1) ? 'st' : (eventNumber === 2) ? 'nd' : (eventNumber === 3) ? 'rd' : 'th';
              $(this).find('h3').text(`${eventNumber}${suffix} Event`);
               // Update input and span IDs and names
              $(this).find('input[type="datetime-local"]').each(function() {
                  const oldId = $(this).attr('id');
                  const newId = oldId.replace(/\d+$/, eventNumber);
                  $(this).attr('id', newId).attr('name', newId);
                   // Update the corresponding error span ID
                  $(`#${oldId}-error`).attr('id', `${newId}-error`);
              });
              // Update the remove button if it exists
              if (eventNumber === 1) {
                  $(this).find('.remove-button').remove(); // Remove button from the first event
              }
               $(this).attr('data-event-number', eventNumber); // Update data attribute
          });
           // Manage "Add Event" button visibility after renumbering
         if (eventCount < MAX_EVENTS) {
             $('#addEventBtn').show();
         }
          console.log("Event numbers and IDs updated.");
     }


    // --- Function to Initialize the Form Features (Comprehensive Validation) ---
    function initializeForm() {
        console.log("Initializing form features..."); // Log when form init starts

        // Initialize Select2 - ONLY on select elements
        $('#operatorName, #selectOption, #siteAttend, #siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown').each(function() {
             if (!$(this).hasClass('select2-hidden-accessible')) { // Prevent re-initialization
                 $(this).select2({
                      placeholder: 'Select...', // Generic placeholder for all
                      allowClear: true,
                      dropdownParent: $('#formContainer')[0] // Ensure dropdown is within the form container (Access DOM element)
                 });
                  console.log(`Select2 initialized on #${this.id}`);
             } else {
                  console.log(`Select2 already initialized on #${this.id}`);
             }
         });
        console.log("Select2 initialization process completed.");

        // --- Set max date for native datetime-local inputs ---
        const nowFormatted = getCurrentDateTimeLocal();
        $('input[type="datetime-local"]').attr('max', nowFormatted);
        console.log(`Set max date/time for datetime-local inputs to: ${nowFormatted}`);


        // --- Event Listeners ---

        // Basic required fields validation on blur (for text inputs)
        $('#ttNumber').on('blur', function() {
            console.log("TT Number blur event fired.");
            if ($(this).closest('.card').is(':visible')) {
               validateField('ttNumber');
            } else {
                 displayError('ttNumber', '');
            }
         });

         // Select2 fields validation on change
         $('#operatorName, #siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown, #selectOption, #siteAttend').on('change', function() {
              const fieldId = $(this).attr('id');
               console.log(`Change event fired on #${fieldId}. Value: ${$(this).val()}`);

              // Handle conditional section display and clearing fields/errors
              if (fieldId === 'selectOption') {
                   console.log("selectOption changed. Handling conditional section display.");
                    if ($(this).val() === 'Misscall TT') {
                        $('#misscallTTFields').show();
                        $('#pgRunFields').hide();
                         // Clear PG Run fields and errors when hiding
                         $('#pgEventsContainer').empty(); // Remove all dynamic event cards
                         eventCount = 0; // Reset event counter
                         $('#addEventBtn').hide(); // Hide add button
                         // Clear errors for removed PG fields
                         // Need a way to clear errors for dynamically added fields when removed.
                         // The validateAllConditionalFields call below will handle clearing visible errors.

                    } else if ($(this).val() === 'PG Run') {
                        $('#misscallTTFields').hide();
                        $('#pgRunFields').show();
                         // Clear Misscall TT fields and errors when hiding
                         $('select', '#misscallTTFields').val(null).trigger('change.select2');
                         $('input[type="datetime-local"]', '#misscallTTFields').val('');
                         $('#siteAttendDateTimeField').hide();
                         // Add the initial 1st event field if PG Run is selected and none exist
                         if (eventCount === 0) {
                             addEventField(1);
                         }
                         $('#addEventBtn').show(); // Show add button
                    } else { // If no option is selected
                        $('#misscallTTFields').hide();
                        $('#pgRunFields').hide();
                         // Clear all conditional fields and errors
                         $('select', '#misscallTTFields, #pgRunFields').val(null).trigger('change.select2');
                         $('input[type="datetime-local"]', '#misscallTTFields, #pgRunFields').val('');
                         $('#siteAttendDateTimeField').hide();
                         $('#pgEventsContainer').empty(); // Remove all dynamic event cards
                         eventCount = 0; // Reset event counter
                         $('#addEventBtn').hide(); // Hide add button
                    }
              } else if (fieldId === 'siteAttend') {
                   if ($(this).val() === 'YES') {
                       $('#siteAttendDateTimeField').show();
                        const nowFormatted = getCurrentDateTimeLocal();
                       $('#siteAttendDateTime').attr('max', nowFormatted);
                   } else {
                       $('#siteAttendDateTimeField').hide();
                       $('#siteAttendDateTime').val('');
                   }
              }

             // Trigger validation after visibility changes and field clearing
              // Only validate standard field if its container is visible
             if ($(this).closest('.card').is(':visible')) {
                 validateField(fieldId);
             } else {
                  displayError(fieldId, ''); // Clear error if hidden
             }
             validateAllConditionalFields(); // Always re-validate conditional fields state
         });

        // Attach validation listener to the initial TT Number field
        $('#ttNumber').on('blur', function() {
            validateField('ttNumber');
        });


        // Attach event listeners for validation to datetime-local inputs
        // These listeners are attached when the inputs are added (dynamic or initial)
        // Initial inputs (pgStart1, pgStop1, etc. if not dynamic initially)
        // Removed fixed listeners here, handled by addEventField or initial add below.


         // --- Add Event Button Listener ---
         $('#addEventBtn').on('click', function() {
             // Before adding a new event, validate the LAST event's start and stop times
             const lastEventNumber = eventCount;
             const lastPgStartId = `pgStart${lastEventNumber}`;
             const lastPgStopId = `pgStop${lastEventNumber}`;

              let lastEventValid = true;

              // Only validate the last event if it exists (i.e., eventCount > 0)
              if (lastEventNumber > 0) {
                   const lastPgStartVal = $(`#${lastPgStartId}`).val();
                   const lastPgStopVal = $(`#${lastPgStopId}`).val();

                   if (!lastPgStartVal || !lastPgStopVal) {
                        alert("Please fill in the Start and Stop times for the current event before adding a new one.");
                        // Trigger validation for the last event to highlight errors
                         validateAllConditionalFields(); // This will validate the last event and show specific errors
                        lastEventValid = false;
                   } else {
                         // Perform sequential date validation for the last event specifically before adding the next
                          const lastPgStart = parseDateTime(lastPgStartVal);
                          const lastPgStop = parseDateTime(lastPgStopVal);
                          const now = new Date();
                          let previousEventStop = null;

                          // Find the stop time of the second-to-last valid event, if it exists
                          if (lastEventNumber > 1) {
                               const previousEventCard = $(`[data-event-number="${lastEventNumber - 1}"]`);
                               const previousPgStopVal = previousEventCard.find(`input[name="pgStop${lastEventNumber - 1}"]`).val();
                               if (previousPgStopVal) {
                                     previousEventStop = parseDateTime(previousPgStopVal);
                               }
                          }


                          if (!lastPgStart || !lastPgStop || lastPgStop <= lastPgStart || lastPgStop > now || (previousEventStop && lastPgStart <= previousEventStop)) {
                                alert("Please fix the date/time errors in the current event before adding a new one.");
                                 validateAllConditionalFields(); // Validate all to show specific errors for the last event
                                lastEventValid = false;
                          } else {
                               // Last event is valid, proceed to add the next
                                validateAllConditionalFields(); // Clear any lingering errors on the last event
                          }
                   }
              } else {
                   // If eventCount is 0, this means the first event hasn't been added yet.
                   // The first event is added when 'PG Run' is selected.
                   // This case should ideally not be reached if the selectOption change handler works correctly.
                   console.warn("Add Event button clicked but eventCount is 0.");
              }


             // Only add the new event if the last event was valid AND we are under the limit
             if (lastEventValid && eventCount < MAX_EVENTS) {
                 addEventField(eventCount + 1);
                 // Scroll to the newly added event (optional)
                  $('html, body').animate({
                     scrollTop: $(`[data-event-number="${eventCount}"]`).offset().top - 100 // Adjust offset as needed
                  }, 500);
             } else if (eventCount >= MAX_EVENTS) {
                 alert(`You can add a maximum of ${MAX_EVENTS} events.`);
             }
         });


       // --- Form Submission Handler ---
       $('#pgForm').submit(function (event) {
         event.preventDefault();
          console.log("Form submission started.");

          // Perform full validation on all relevant fields before submitting
          let formIsValid = true;
          console.log("Running pre-submit validation...");

           // Validate mandatory fields that are currently visible
            if ($('#ttNumber').closest('.card').is(':visible')) {
                 console.log("Validating TT Number.");
                if (!validateField('ttNumber')) formIsValid = false;
            }
            if ($('#operatorName').closest('.card').is(':visible')) {
                 console.log("Validating Operator Name.");
                if (!validateField('operatorName')) formIsValid = false;
            }
             // Corrected field IDs for validation check
            if ($('#siteDropdown').closest('.card').is(':visible')) {
                 console.log("Validating Site.");
                if (!validateField('siteDropdown')) formIsValid = false;
            }
             // Corrected field IDs for validation check
            if ($('#pgOperatorDropdown').closest('.card').is(':visible')) {
                 console.log("Validating PG Operator.");
                if (!validateField('pgOperatorDropdown')) formIsValid = false;
            }
             // Corrected field IDs for validation check
            if ($('#teamLeaderDropdown').closest('.card').is(':visible')) {
                 console.log("Validating Team Leader.");
                if (!validateField('teamLeaderDropdown')) formIsValid = false;
            }
            if ($('#selectOption').closest('.card').is(':visible')) {
                 console.log("Validating Select Option.");
                if (!validateField('selectOption')) formIsValid = false;
            }


          // Validate conditional fields (including PG events and Site Attend Date/Time)
           console.log("Running final conditional date/time validation before submit.");
          formIsValid = validateAllConditionalFields() && formIsValid;
           console.log("Overall form validation result:", formIsValid);


          if (!formIsValid) {
             $('.loading').hide();
             alert('Please fix the errors in the form before submitting.');
             console.log("Form validation failed before submit.");
             return;
          }
          console.log("Form validation passed. Preparing data for submission.");


          // Collect data dynamically, especially PG Run events
          const jsonData = {};

          // Collect standard fields
          jsonData['ttNumber'] = $('#ttNumber').val() || '';
          jsonData['operatorName'] = $('#operatorName').val() || '';
          jsonData['site'] = $('#siteDropdown').val() || '';
          jsonData['pgOperator'] = $('#pgOperatorDropdown').val() || '';
          jsonData['teamLeader'] = $('#teamLeaderDropdown').val() || '';
          jsonData['selectOption'] = $('#selectOption').val() || '';
          jsonData['siteAttend'] = $('#siteAttend').val() || '';
          jsonData['siteAttendDateTime'] = $('#siteAttendDateTime').val() || '';

           // Collect PG Run events dynamically
           if (jsonData['selectOption'] === 'PG Run') {
               jsonData.pgEvents = []; // Initialize an array to hold PG events
                $('#pgEventsContainer').children('.event-card').each(function() {
                    const eventNumber = $(this).data('event-number'); // Get the event number from data attribute
                    const pgStartVal = $(`#pgStart${eventNumber}`).val();
                    const pgStopVal = $(`#pgStop${eventNumber}`).val();

                    // Only include the event in the submitted data if both start and stop times are filled
                    if (pgStartVal && pgStopVal) {
                        jsonData.pgEvents.push({
                            eventNumber: eventNumber,
                            start: pgStartVal,
                            stop: pgStopVal
                        });
                    }
                });
               console.log("Collected PG Events:", jsonData.pgEvents);
           }


         jsonData.timestamp = new Date().toISOString(); // Add timestamp

         console.log("Data being sent:", JSON.stringify(jsonData, null, 2));

         $('.loading').show(); // Show loading message

         // Send form data to Google Apps Script via proxy
         fetch('/.netlify/functions/proxy', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify(jsonData) // Send the collected JSON data
         })
         .then(response => {
             console.log("Form Fetch Response Status:", response.status);
             console.log("Form Fetch Response OK:", response.ok);

             if (!response.ok) {
                 return response.text().then(text => {
                      console.error(`Form HTTP error! status: ${response.status}, body: ${text}`);
                      throw new Error(`Form HTTP error! status: ${response.status}, body: ${text}`);
                 });
             }

              const contentType = response.headers.get("content-type");
             if (contentType && (contentType.includes("application/json") || contentType.includes("text/plain"))) {
                  return response.text().then(text => {
                       try {
                          if (!text || text.trim() === '') {
                               console.warn("Received empty response body for form submission.");
                              return {};
                          }
                           return JSON.parse(text);
                       } catch (jsonError) {
                          console.error('Failed to parse form response as JSON:', jsonError, 'Response text:', text);
                          throw new Error('Failed to parse JSON response from server for form submission.');
                       }
                  });
             } else {
                  return response.text().then(text => {
                       console.error('Received unexpected content type from server for form submission:', contentType, 'Response text:', text);
                       throw new Error('Received unexpected response from server for form submission. Check Apps Script logs.');
                  });
             }
         })
         .then(result => {
           $('.loading').hide(); // Hide loading message
           console.log("Form Response JSON Result:", result);

           if (result && typeof result === 'object' && result.result === 'success') {
               $('.success-message').show();
               $('#pgForm')[0].reset();

                // Reset Select2 dropdowns and trigger change
               $('#operatorName, #selectOption, #siteAttend').val(null).trigger('change.select2');
               $('#siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown').val(null).trigger('change.select2');
                $('.select2-selection__rendered').empty().append('<span class="select2-selection__placeholder">Select...</span>');

                // Clear native datetime-local inputs
                 $('input[type="datetime-local"]').val('');

               // Clear and reset dynamic PG Run fields
               $('#pgEventsContainer').empty(); // Remove all dynamic cards
               eventCount = 0; // Reset counter
               $('#addEventBtn').hide(); // Hide the add button initially


               // Clear all validation errors and invalid classes
               $('.error-message').text('');
               $('input, select').removeClass('is-invalid');
               $('.select2-container .select2-selection--single').removeClass('is-invalid');


               setTimeout(() => { $('.success-message').hide(); }, 3000);
           } else {
                console.error('Submission result was not successful:', result);
               const errorMessage = (result && typeof result === 'object' && result.error) ? result.error : (result === null || result === undefined || Object.keys(result).length === 0 ? 'Received empty or null response from server.' : 'Unknown response format from server.');
               alert('Submission failed: ' + errorMessage + ' Check browser console and Apps Script logs.');
           }
         })
         .catch(error => {
           $('.loading').hide();
           alert('Submission failed: ' + error.message);
           console.error('Fetch Error:', error);
         });
       });
        console.log("Form submission handler set up.");


        // --- Initial Setup for the form when it is displayed ---
        // Trigger change on selectOption and siteAttend to set initial display state and validation
        // Ensure PG Run fields are cleared initially
        $('#selectOption').val(null).trigger('change.select2');
        $('#siteAttend').val(null).trigger('change.select2');

         // Initially hide the add event button
        $('#addEventBtn').hide();


        // Trigger initial validation for required fields on load (optional)
        $('#ttNumber').trigger('blur');
        $('#operatorName, #siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown').trigger('change.select2');


        console.log("Form initialization complete.");

    } // End of initializeForm function


    // --- Login Page JavaScript --- (remains the same)

    function displayLoginError(fieldId, message) {
        const errorSpan = $(`#${fieldId}-error`);
        const fieldElement = $(`#${fieldId}`);
        const loginStatusDiv = $('#login-status');

        if (!fieldElement.length) {
            console.error(`Login field element #${fieldId} not found.`);
            if (errorSpan.length) errorSpan.text('');
            return;
        }

        if (errorSpan.length) {
            if (message) {
                errorSpan.text(message);
                fieldElement.addClass('is-invalid');
            } else {
                errorSpan.text('');
                fieldElement.removeClass('is-invalid');
            }
        }

        if (fieldId === 'login-status') {
            loginStatusDiv.text(message);
            if (message) {
                 if (message.includes('Invalid') || message.includes('failed') || message.includes('Error')) {
                      loginStatusDiv.addClass('error').removeClass('success');
                 } else {
                      loginStatusDiv.addClass('success').removeClass('error');
                 }
                 loginStatusDiv.show();
            } else {
                 loginStatusDiv.text('').removeClass('success error').hide();
            }
        }
    }

    $('#loginForm').submit(function(event) {
      event.preventDefault();
       console.log("Login form submitted.");

      displayLoginError('username', '');
      displayLoginError('password', '');
      displayLoginError('login-status', '');

      const username = $('#username').val().trim();
      const password = $('#password').val().trim();
      let formIsValid = true;

      if (!username) {
        displayLoginError('username', 'Username is required.');
        formIsValid = false;
      }
      if (!password) {
        displayLoginError('password', 'Password is required.');
        formIsValid = false;
      }

      if (!formIsValid) {
         displayLoginError('login-status', 'Please enter username and password.');
         console.log("Login form validation failed client-side.");
        return;
      }

       displayLoginError('login-status', 'Logging in...');
       console.log("Attempting to fetch login endpoint.");

      fetch('/.netlify/functions/proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ login: true, username: username, password: password })
      })
      .then(response => {
           console.log("Login Fetch received response.");
          return response.text().then(text => {
               console.log("Login Fetch Raw Response Text:", text);
               console.log("Login Fetch Response Status:", response.status);
               console.log("Login Fetch Response OK:", response.ok);

               let data = null;
               try {
                   if (text && text.trim() !== '') {
                       data = JSON.parse(text);
                        console.log("Login Fetch Parsed Data:", data);
                   } else {
                       console.error("Received empty or null response body for login.");
                       if (response.ok) {
                           throw new Error('Received empty response body from server.');
                       } else {
                           throw new Error(`Server returned status ${response.status} with empty body.`);
                       }
                   }
               } catch (jsonError) {
                   console.error('Failed to parse login response as JSON:', jsonError, 'Response text:', text);
                   if (response.ok) {
                        throw new Error('Login failed: Invalid JSON response from server.');
                   } else {
                        throw new Error(`Server returned status ${response.status} and invalid response format.`);
                   }
               }

               if (!response.ok) {
                   const serverErrorMessage = (data && typeof data === 'object' && data.error) ? data.error : 'Server error occurred.';
                   throw new Error(`Login failed: Status ${response.status} - ${serverErrorMessage}`);
               }

               return data;
          });
      })
      .then(data => {
        console.log("Login Response Data:", data);
        if (data && typeof data === 'object' && data.success === true) {
          displayLoginError('login-status', 'Login successful!');
          console.log("Login successful, showing form.");
          $('#loginContainer').hide();
          $('#formContainer').show();
           initializeForm(); // Initialize form features after successful login
        } else {
          const errorMessage = (data && typeof data === 'object' && data.error) ? data.error : 'Invalid username or password.';
          displayLoginError('login-status', errorMessage);
           console.log("Login failed:", errorMessage);
           $('#password').val('');
          $('#username, #password').removeClass('is-invalid');
        }
      })
      .catch(error => {
        console.error('Login Fetch Error:', error);
        displayLoginError('login-status', 'Login failed: ' + error.message);
         $('#username, #password').removeClass('is-invalid');
      });
    });

      $('#username, #password').on('focus', function() {
          displayLoginError($(this).attr('id'), '');
          displayLoginError('login-status', '');
      });

    // --- Initial State on document ready ---
     $('#formContainer').hide();
     $('#loginContainer').show();
      console.log("Initial display state set: login visible, form hidden.");


  }); // End of $(document).ready
</script>

</body>
</html>