<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E.CO PG Run Data Collection Form - MPL</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <style>
    /* Add some basic styling for clarity if styles.css isn't present */
    body { font-family: sans-serif; margin: 20px; }
    .container, .login-container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    .card { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
    .input-group, .card > label { display: block; margin-bottom: 10px; }
    label { font-weight: bold; margin-bottom: 5px; display: inline-block; }
    input[type="text"], input[type="password"], input[type="datetime-local"], select { width: 100%; padding: 8px; margin-bottom: 5px; box-sizing: border-box; }
    .error-message { color: red; font-size: 0.8em; display: block; margin-bottom: 10px; }
    .is-invalid { border-color: red !important; }
    .select2-container .select2-selection--single.is-invalid { border: 1px solid red !important; }
    button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .add-button, .remove-button { background-color: #28a745; margin-top: 10px; }
    .remove-button { background-color: #dc3545; }
    .loading, .success-message, .login-message { display: none; margin-top: 10px; }
    .success-message { color: green; }
    .login-message.error { color: red; }
    .footer-info { text-align: center; margin-top: 30px; font-size: 0.9em; color: #555; }
    .select2-container { width: 100% !important; }
  </style>
</head>
<body>

<div class="login-container" id="loginContainer">
  <h2>Login</h2>
  <form id="loginForm">
    <div class="input-group">
      <label for="username">Username:</label>
      <input type="text" id="username" name="username" required placeholder="Enter your username">
      <span class="error-message" id="username-error"></span>
    </div>

    <div class="input-group">
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" required placeholder="Enter your password">
      <span class="error-message" id="password-error"></span>
    </div>

    <button type="submit">Login</button>

    <div class="login-message" id="login-status"></div>
  </form>
</div>

<div id="formContainer" style="display: none;">
  <div class="container">
    <h2>E.CO PG Run Data Collection Form-MPL</h2>
    <form id="pgForm" novalidate>
      <div class="card">
        <label for="ttNumber">TT Number:</label>
        <input type="text" id="ttNumber" name="ttNumber" />
        <span class="error-message" id="ttNumber-error"></span>

        <label for="operatorName">Operator Name:</label>
        <select id="operatorName" name="operatorName">
          <option value="" disabled selected>Select an operator</option>
          <option value="GP">GP</option>
          <option value="BL">BL</option>
          <option value="ROBI">ROBI</option>
        </select>
         <span class="error-message" id="operatorName-error"></span>

        <label for="siteDropdown">Select Site:</label>
        <select id="siteDropdown" name="site"></select>
        <span class="error-message" id="siteDropdown-error"></span>
      </div>

      <div class="card">
        <label for="pgOperatorDropdown">Select PG Operator Name:</label>
        <select id="pgOperatorDropdown" name="pgOperator"></select>
         <span class="error-message" id="pgOperatorDropdown-error"></span>

        <label for="teamLeaderDropdown">Select Team Leader Name:</label>
        <select id="teamLeaderDropdown" name="teamLeader"></select>
         <span class="error-message" id="teamLeaderDropdown-error"></span>
      </div>

      <div class="card">
        <label for="selectOption">Select Option:</label>
        <select id="selectOption" name="selectOption">
          <option value="" disabled selected>Select an option</option>
          <option value="Misscall TT">Misscall TT</option>
          <option value="PG Run">PG Run</option>
        </select>
        <span class="error-message" id="selectOption-error"></span>
      </div>

      <div id="misscallTTFields" style="display: none;">
        <div class="card">
          <label for="siteAttend">Site Attend:</label>
          <select id="siteAttend" name="siteAttend">
            <option value="" disabled selected>Select an option</option>
            <option value="YES">YES</option>
            <option value="NO">NO</option>
          </select>
           <span class="error-message" id="siteAttend-error"></span>
        </div>
        <div id="siteAttendDateTimeField" style="display: none;">
           <div class="card">
             <label for="siteAttendDateTime">Site Attend Date & Time:</label>
               <input type="datetime-local" id="siteAttendDateTime" name="siteAttendDateTime" />
               <span class="error-message" id="siteAttendDateTime-error"></span>
           </div>
        </div>
      </div>

      <div id="pgRunFields" style="display: none;">
        <div id="pgEventsContainer">
             </div>
        <button type="button" id="addEventBtn" class="add-button" style="display: none;">Add Another Event</button>
      </div>

       <button type="submit">Submit</button>
        <div class="loading">Submitting...</div>
        <div class="success-message">Submission successful!</div>
    </form>
  </div>
  </div>


<div class="footer-info">
  <p>Powered and Developed By<br>
  <strong>Rakibul Islam Ratul</strong><br>
  <small>Sr. Manager, Central Governance, Metal Plus Ltd.</small></p>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
  $(document).ready(function () {
    console.log("Document ready.");

    const MAX_EVENTS = 10;
    let eventCount = 0;
    let loggedInUsername = '';

    function getCurrentDateTimeLocal() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function parseDateTime(datetimeStr) {
        if (!datetimeStr) return null;
        const date = new Date(datetimeStr);
        return isNaN(date.getTime()) ? null : date;
    }

    function displayError(fieldId, message) {
        const errorSpan = $(`#${fieldId}-error`);
        const fieldElement = $(`#${fieldId}`);
        if (!fieldElement.length) return;

        const container = fieldElement.next('.select2-container');

        if (message) {
            if (errorSpan.length) errorSpan.text(message);
            fieldElement.addClass('is-invalid');
            if (container.length) container.find('.select2-selection--single').addClass('is-invalid');
        } else {
            if (errorSpan.length) errorSpan.text('');
            fieldElement.removeClass('is-invalid');
            if (container.length) container.find('.select2-selection--single').removeClass('is-invalid');
        }
    }

    function validateField(fieldId) {
        const value = $(`#${fieldId}`).val();
        if (!value) {
            displayError(fieldId, 'This field is mandatory.');
            return false;
        } else {
            displayError(fieldId, '');
            return true;
        }
    }

    function validateAllConditionalFields() {
        const selectOption = $('#selectOption').val();
        let allValid = true;

        if (selectOption === 'Misscall TT' && $('#misscallTTFields').is(':visible')) {
            if (!validateField('siteAttend')) allValid = false;
            const siteAttend = $('#siteAttend').val();
            if (siteAttend === 'YES' && $('#siteAttendDateTimeField').is(':visible')) {
                const siteAttendDateTimeVal = $('#siteAttendDateTime').val();
                if (!siteAttendDateTimeVal) {
                    displayError('siteAttendDateTime', 'Date & Time is mandatory when Site Attend is YES.');
                    allValid = false;
                } else {
                    const siteAttendDateTime = parseDateTime(siteAttendDateTimeVal);
                    const now = new Date();
                    if (!siteAttendDateTime || siteAttendDateTime > now) {
                         displayError('siteAttendDateTime', 'Invalid or future date/time.');
                         allValid = false;
                    } else {
                        displayError('siteAttendDateTime', '');
                    }
                }
            } else {
                 displayError('siteAttendDateTime', '');
            }
        } else {
            displayError('siteAttend', '');
            displayError('siteAttendDateTime', '');
        }

        if (selectOption === 'PG Run' && $('#pgRunFields').is(':visible')) {
            let previousEventStop = null;
            $('#pgEventsContainer .event-card').each(function(index) {
                const eventNumber = $(this).data('event-number');
                const pgStartId = `pgStart${eventNumber}`;
                const pgStopId = `pgStop${eventNumber}`;
                const fuelUsedFromId = `fuelUsedFrom${eventNumber}`;
                const pgStartVal = $(`#${pgStartId}`).val();
                const pgStopVal = $(`#${pgStopId}`).val();
                const fuelUsedFromVal = $(`#${fuelUsedFromId}`).val();
                const pgStart = parseDateTime(pgStartVal);
                const pgStop = parseDateTime(pgStopVal);
                const now = new Date();
                let currentEventValid = true;

                if (pgStartVal || pgStopVal || fuelUsedFromVal) {
                    if (!pgStartVal) { displayError(pgStartId, 'Mandatory.'); allValid = false; currentEventValid = false; } else { displayError(pgStartId, ''); }
                    if (!pgStopVal) { displayError(pgStopId, 'Mandatory.'); allValid = false; currentEventValid = false; } else { displayError(pgStopId, ''); }
                    if (!fuelUsedFromVal) { displayError(fuelUsedFromId, 'Mandatory.'); allValid = false; currentEventValid = false; } else { displayError(fuelUsedFromId, ''); }

                    if (pgStart && pgStop) {
                         if (pgStop <= pgStart) { displayError(pgStopId, 'Must be after Start.'); allValid = false; currentEventValid = false; }
                         if (pgStart > now) { displayError(pgStartId, 'No future dates.'); allValid = false; currentEventValid = false; }
                         if (pgStop > now) { displayError(pgStopId, 'No future dates.'); allValid = false; currentEventValid = false; }
                         if (previousEventStop && pgStart <= previousEventStop) { displayError(pgStartId, `Must be after Event ${eventNumber - 1}'s Stop.`); allValid = false; currentEventValid = false; }

                         if (currentEventValid) { previousEventStop = pgStop; }
                         else { previousEventStop = null; }
                    } else { previousEventStop = null; }
                } else {
                     displayError(pgStartId, '');
                     displayError(pgStopId, '');
                     displayError(fuelUsedFromId, '');
                     previousEventStop = null;
                }
            });
        } else {
             $('#pgEventsContainer .event-card').each(function() {
                 const eventNumber = $(this).data('event-number');
                 displayError(`pgStart${eventNumber}`, '');
                 displayError(`pgStop${eventNumber}`, '');
                 displayError(`fuelUsedFrom${eventNumber}`, '');
             });
        }
        return allValid;
    }

     function addEventField(eventNumber) {
         const nowFormatted = getCurrentDateTimeLocal();
         const suffix = (eventNumber === 1) ? 'st' : (eventNumber === 2) ? 'nd' : (eventNumber === 3) ? 'rd' : 'th';
         const eventCardHtml = `
            <div class="event-card" data-event-number="${eventNumber}">
              <h3>${eventNumber}${suffix} Event</h3>
               <label for="pgStart${eventNumber}">PG Start Date & Time:</label>
               <input type="datetime-local" id="pgStart${eventNumber}" name="pgStart${eventNumber}" max="${nowFormatted}" />
               <span class="error-message" id="pgStart${eventNumber}-error"></span>

              <label for="pgStop${eventNumber}">PG Stop Date & Time:</label>
               <input type="datetime-local" id="pgStop${eventNumber}" name="pgStop${eventNumber}" max="${nowFormatted}" />
               <span class="error-message" id="pgStop${eventNumber}-error"></span>

               <label for="fuelUsedFrom${eventNumber}">Fuel Used From:</label>
               <select id="fuelUsedFrom${eventNumber}" name="fuelUsedFrom${eventNumber}"></select>
               <span class="error-message" id="fuelUsedFrom${eventNumber}-error"></span>

               ${eventNumber > 1 ? '<button type="button" class="remove-button">Remove Event</button>' : ''}
            </div>
          `;
         $('#pgEventsContainer').append(eventCardHtml);
         eventCount++;

         const eventCard = $(`[data-event-number="${eventNumber}"]`);
         const newFuelDropdown = $(`#fuelUsedFrom${eventNumber}`);

         // *** CORRECTION: Populate from pgOperatorDropdown HTML ***
         const pgOperatorOptions = $('#pgOperatorDropdown').html();
         newFuelDropdown.html(pgOperatorOptions); // Copy options

         newFuelDropdown.select2({
              placeholder: 'Select...',
              allowClear: true,
              dropdownParent: eventCard[0]
         }).val(null).trigger('change'); // Set to blank initially

         $('#pgEventsContainer').on('change blur', `#pgStart${eventNumber}, #pgStop${eventNumber}`, validateAllConditionalFields);
         $('#pgEventsContainer').on('change', `#fuelUsedFrom${eventNumber}`, validateAllConditionalFields);

         if (eventNumber > 1) {
              eventCard.find('.remove-button').on('click', function() {
                  $(this).closest('.event-card').remove();
                  eventCount--;
                  updateEventNumbers();
                  validateAllConditionalFields();
              });
         }

         $('#addEventBtn').toggle(eventCount < MAX_EVENTS);
         console.log(`Added Event ${eventNumber}. Total events: ${eventCount}`);
     }

     function updateEventNumbers() {
          $('#pgEventsContainer .event-card').each(function(index) {
              const newEventNumber = index + 1;
              const suffix = (newEventNumber === 1) ? 'st' : (newEventNumber === 2) ? 'nd' : (newEventNumber === 3) ? 'rd' : 'th';
              const card = $(this);
              card.data('event-number', newEventNumber);
              card.attr('data-event-number', newEventNumber);
              card.find('h3').text(`${newEventNumber}${suffix} Event`);
              card.find('input, select, span').each(function() {
                  const el = $(this);
                  ['id', 'name', 'for'].forEach(attr => {
                      const oldVal = el.attr(attr);
                      if (oldVal && /\d+$/.test(oldVal)) {
                          el.attr(attr, oldVal.replace(/\d+$/, newEventNumber));
                      }
                  });
              });
              // Ensure only the first event lacks a remove button
              card.find('.remove-button').remove();
              if (newEventNumber > 1) {
                  card.append('<button type="button" class="remove-button">Remove Event</button>');
                  card.find('.remove-button').on('click', function() {
                       $(this).closest('.event-card').remove();
                       eventCount--;
                       updateEventNumbers();
                       validateAllConditionalFields();
                   });
              }
          });
          $('#addEventBtn').show();
          console.log("Event numbers updated.");
     }

    async function fetchAndPopulateDropdown(dropdownId, sheetName, columnName) {
        console.log(`Workspaceing for #${dropdownId} from ${sheetName}/${columnName}`);
        const dropdown = $(`#${dropdownId}`);
        if (!dropdown.length) {
            console.error(`#${dropdownId} not found.`);
            return;
        }

        dropdown.empty().append('<option value=""></option>'); // Clear and add blank

        try {
            const response = await fetch('/.netlify/functions/proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'getDropdownData', sheet: sheetName, column: columnName })
            });

            if (!response.ok) throw new Error(`Workspace failed: ${response.status}`);
            const data = await response.json();

            if (data && Array.isArray(data.data)) {
                data.data.forEach(item => {
                    if (item) dropdown.append(new Option(item, item));
                });
                console.log(`Populated #${dropdownId}.`);
            } else { throw new Error('Invalid data format.'); }

        } catch (error) {
            console.error(`Error for #${dropdownId}:`, error);
            alert(`Failed to load data for ${dropdownId}.`);
        } finally {
             if (dropdown.hasClass('select2-hidden-accessible')) {
                  dropdown.val(null).trigger('change.select2');
             } else {
                  dropdown.val('');
             }
        }
    }

    // *** CORRECTION: Made initializeForm async and added await ***
    async function initializeForm() {
        console.log("Initializing form features...");

        $('#operatorName, #selectOption, #siteAttend, #siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown').each(function() {
             if (!$(this).hasClass('select2-hidden-accessible')) {
                 $(this).select2({ placeholder: 'Select...', allowClear: true, dropdownParent: $('#formContainer') });
             }
         });
        console.log("Select2 initialized.");

        const nowFormatted = getCurrentDateTimeLocal();
        $('input[type="datetime-local"]').attr('max', nowFormatted);

        console.log("Fetching dropdown data...");
        try {
            await fetchAndPopulateDropdown('siteDropdown', 'Sites', 'Site_Code');
            await fetchAndPopulateDropdown('pgOperatorDropdown', 'Employees', 'Employee_Code');
            await fetchAndPopulateDropdown('teamLeaderDropdown', 'Employees', 'Employee_Code');
            console.log("Dropdown data fetch complete.");
        } catch (error) {
            console.error("Critical error fetching dropdowns:", error);
            alert("Could not load form data. Please refresh.");
            return;
        }

        // --- Event Listeners ---
        $('#ttNumber').on('blur', () => validateField('ttNumber'));

         $('#operatorName, #siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown, #selectOption, #siteAttend').on('change', function() {
              const fieldId = $(this).attr('id');
              validateField(fieldId);

              if (fieldId === 'selectOption') {
                   const val = $(this).val();
                   $('#misscallTTFields').toggle(val === 'Misscall TT');
                   $('#pgRunFields').toggle(val === 'PG Run');
                   $('#addEventBtn').hide(); // Always hide first

                   if (val === 'PG Run') {
                       $('#misscallTTFields select').val(null).trigger('change');
                       $('#misscallTTFields input').val('');
                       $('#siteAttendDateTimeField').hide();
                       if (eventCount === 0) addEventField(1);
                       $('#addEventBtn').toggle(eventCount < MAX_EVENTS);
                   } else if (val === 'Misscall TT') {
                       $('#pgEventsContainer').empty(); eventCount = 0;
                   } else {
                       $('#misscallTTFields, #pgRunFields').hide();
                       $('#pgEventsContainer').empty(); eventCount = 0;
                       $('#misscallTTFields select').val(null).trigger('change');
                       $('#misscallTTFields input').val('');
                   }
              } else if (fieldId === 'siteAttend') {
                   $('#siteAttendDateTimeField').toggle($(this).val() === 'YES');
                   if ($(this).val() !== 'YES') $('#siteAttendDateTime').val('');
              }
              validateAllConditionalFields();
         });

         $('#addEventBtn').on('click', function() {
             if (eventCount > 0 && !validateAllConditionalFields()) {
                 alert("Please fix errors in the current event before adding a new one.");
                 return;
             }
             if (eventCount < MAX_EVENTS) {
                 addEventField(eventCount + 1);
                 $('html, body').animate({ scrollTop: $(`[data-event-number="${eventCount}"]`).offset().top - 100 }, 500);
             } else {
                 alert(`Maximum of ${MAX_EVENTS} events reached.`);
             }
         });

       $('#pgForm').submit(function (event) {
         event.preventDefault();
         console.log("Submitting...");

         let formIsValid = true;
         ['ttNumber', 'operatorName', 'siteDropdown', 'pgOperatorDropdown', 'teamLeaderDropdown', 'selectOption'].forEach(id => {
             if (!validateField(id)) formIsValid = false;
         });
         if (!validateAllConditionalFields()) formIsValid = false;

         if (!formIsValid) {
             alert('Please fix errors before submitting.');
             console.log("Submit failed: Validation errors.");
             return;
         }

         $('.loading').show();
         const jsonData = {
             ttNumber: $('#ttNumber').val() || '',
             operatorName: $('#operatorName').val() || '',
             site: $('#siteDropdown').val() || '',
             pgOperator: $('#pgOperatorDropdown').val() || '',
             teamLeader: $('#teamLeaderDropdown').val() || '',
             selectOption: $('#selectOption').val() || '',
             siteAttend: $('#siteAttend').val() || '',
             siteAttendDateTime: $('#siteAttendDateTime').val() || '',
             entryBy: loggedInUsername,
             timestamp: new Date().toISOString(),
             pgEvents: []
         };

         if (jsonData.selectOption === 'PG Run') {
             $('#pgEventsContainer .event-card').each(function() {
                 const eventNumber = $(this).data('event-number');
                 const start = $(`#pgStart${eventNumber}`).val();
                 const stop = $(`#pgStop${eventNumber}`).val();
                 const fuel = $(`#fuelUsedFrom${eventNumber}`).val();
                 if (start && stop && fuel) {
                     jsonData.pgEvents.push({ eventNumber, start, stop, fuelUsedFrom: fuel });
                 }
             });
             if (jsonData.pgEvents.length === 0) {
                 alert("Please enter at least one full PG Run event.");
                 $('.loading').hide();
                 return;
             }
         }

         console.log("Sending:", jsonData);

         fetch('/.netlify/functions/proxy', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify(jsonData)
         })
         .then(response => response.ok ? response.json() : response.text().then(text => Promise.reject(new Error(text || `HTTP error ${response.status}`))))
         .then(result => {
           $('.loading').hide();
           console.log("Response:", result);
           if (result && result.result === 'success') {
               $('.success-message').show();
               $('#pgForm')[0].reset();
               $('select').val(null).trigger('change.select2');
               $('#pgEventsContainer').empty(); eventCount = 0;
               $('#addEventBtn').hide();
               $('.error-message').text('');
               $('input, select').removeClass('is-invalid');
               $('.select2-container .select2-selection--single').removeClass('is-invalid');
               setTimeout(() => $('.success-message').hide(), 3000);
           } else {
               const errorMsg = (result && result.error) ? (result.error.message || result.error) : 'Unknown submission error.';
               alert('Submission failed: ' + errorMsg);
               // Handle specific conflict errors if needed
           }
         })
         .catch(error => {
           $('.loading').hide();
           alert('Submission failed: ' + error.message);
           console.error('Fetch Error:', error);
         });
       });
    }

    // --- Login Page JavaScript ---
    function displayLoginError(fieldId, message) {
        const errorSpan = $(`#${fieldId}-error`);
        const fieldElement = $(`#${fieldId}`);
        const loginStatusDiv = $('#login-status');

        if (errorSpan.length) {
            errorSpan.text(message || '');
            fieldElement.toggleClass('is-invalid', !!message);
        }
        if (fieldId === 'login-status') {
            loginStatusDiv.text(message || '').toggleClass('error', !!message).toggle(!!message);
        }
    }

    $('#loginForm').submit(function(event) {
        event.preventDefault();
        displayLoginError('username', '');
        displayLoginError('password', '');
        displayLoginError('login-status', '');

        const username = $('#username').val().trim();
        const password = $('#password').val().trim();
        if (!username || !password) {
            if (!username) displayLoginError('username', 'Required.');
            if (!password) displayLoginError('password', 'Required.');
            displayLoginError('login-status', 'Please enter username and password.');
            return;
        }

        displayLoginError('login-status', 'Logging in...');

        fetch('/.netlify/functions/proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ login: true, username: username, password: password })
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
            if (!ok || !data.success) {
                throw new Error((data && data.error) || 'Invalid username or password.');
            }
            displayLoginError('login-status', 'Login successful!');
            loggedInUsername = username;
            $('#loginContainer').hide();
            $('#formContainer').show();
            initializeForm(); // Call the (now async) form initializer
        })
        .catch(error => {
            console.error('Login Error:', error);
            displayLoginError('login-status', 'Login failed: ' + error.message);
            $('#password').val('');
        });
    });

    $('#username, #password').on('focus', function() {
        displayLoginError($(this).attr('id'), '');
        displayLoginError('login-status', '');
    });

    $('#formContainer').hide();
    $('#loginContainer').show();
  });
</script>

</body>
</html>