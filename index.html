<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E.CO PG Run Data Collection Form - MPL</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
   <style>
    /* Temporary style adjustments for Select2 error messages if needed */
    /* These should ideally be in your main styles.css */
    .select2-container + .error-message {
         margin-top: 5px; /* Space between the Select2 dropdown and the error message */
         /* Adjust other padding/margins if needed based on your final CSS */
    }
     .error-message {
        color: red;
        font-size: 0.8em;
        display: block; /* Ensure it takes its own line */
        margin-top: 5px; /* Add space above the error message */
        margin-bottom: 15px; /* Add space below the error message */
        min-height: 1em; /* Reserve space to prevent layout shifts */
        padding: 0 5px; /* Optional: add slight horizontal padding */
    }

    input.is-invalid,
    select.is-invalid {
        border-color: red !important; /* Use !important to override other border styles */
        box-shadow: 0 0 5px rgba(255, 0, 0, 0.5); /* Optional: add a red shadow */
    }

    .select2-container--default .select2-selection--single.is-invalid {
         border-color: red !important;
         box-shadow: 0 0 5px rgba(255, 0, 0, 0.5); /* Optional: add a red shadow */
    }

   </style>
</head>
<body>
  <div class="container">
    <h2>E.CO PG Run Data Collection Form-MPL</h2>
    <form id="pgForm" novalidate> <div class="card">
        <label for="ttNumber">TT Number:</label>
        <input type="text" id="ttNumber" name="ttNumber" />
        <span class="error-message" id="ttNumber-error"></span>

        <label for="operatorName">Operator Name:</label>
        <select id="operatorName" name="operatorName"> <option value="" disabled selected>Select an operator</option>
          <option value="GP">GP</option>
          <option value="BL">BL</option>
          <option value="ROBI">ROBI</option>
        </select>
         <span class="error-message" id="operatorName-error"></span>

        <label for="siteDropdown">Select Site:</label>
        <select id="siteDropdown" name="site"></select> <span class="error-message" id="site-error"></span>
      </div>

      <div class="card">
        <label for="pgOperatorDropdown">Select PG Operator Name:</label>
        <select id="pgOperatorDropdown" name="pgOperator"></select> <span class="error-message" id="pgOperator-error"></span>

        <label for="teamLeaderDropdown">Select Team Leader Name:</label>
        <select id="teamLeaderDropdown" name="teamLeader"></select> <span class="error-message" id="teamLeader-error"></span>
      </div>

      <div class="card">
        <label for="selectOption">Select Option:</label>
        <select id="selectOption" name="selectOption"> <option value="" disabled selected>Select an option</option>
          <option value="Misscall TT">Misscall TT</option>
          <option value="PG Run">PG Run</option>
        </select>
        <span class="error-message" id="selectOption-error"></span>
      </div>

      <div id="misscallTTFields" style="display: none;" class="card">
        <label for="siteAttend">Site Attend:</label>
        <select id="siteAttend" name="siteAttend"> <option value="" disabled selected>Select an option</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
        </select>
         <span class="error-message" id="siteAttend-error"></span>

        <div id="siteAttendDateTimeField" style="display: none;">
          <label for="siteAttendDateTime">Site Attend Date & Time:</label>
          <input type="datetime-local" id="siteAttendDateTime" name="siteAttendDateTime" />
          <span class="error-message" id="siteAttendDateTime-error"></span>
        </div>
      </div>

      <div id="pgRunFields" style="display: none;">
        <div class="event-card">
          <h3>1st Event</h3>
          <label for="pgStart1">PG Start Date & Time:</label>
          <input type="datetime-local" id="pgStart1" name="pgStart1" />
           <span class="error-message" id="pgStart1-error"></span>
          <label for="pgStop1">PG Stop Date & Time:</label>
          <input type="datetime-local" id="pgStop1" name="pgStop1" />
           <span class="error-message" id="pgStop1-error"></span>
        </div>

        <div class="event-card">
          <h3>2nd Event</h3>
          <label for="pgStart2">PG Start Date & Time:</label>
          <input type="datetime-local" id="pgStart2" name="pgStart2" />
           <span class="error-message" id="pgStart2-error"></span>
          <label for="pgStop2">PG Stop Date & Time:</label>
          <input type="datetime-local" id="pgStop2" name="pgStop2" />
           <span class="error-message" id="pgStop2-error"></span>
        </div>

        <div class="event-card">
          <h3>3rd Event</h3>
          <label for="pgStart3">PG Start Date & Time:</label>
          <input type="datetime-local" id="pgStart3" name="pgStart3" />
           <span class="error-message" id="pgStart3-error"></span>
          <label for="pgStop3">PG Stop Date & Time:</label>
          <input type="datetime-local" id="pgStop3" name="pgStop3" />
           <span class="error-message" id="pgStop3-error"></span>
        </div>
      </div>

      <button type="submit">Submit</button>
    </form>
    <div class="loading">Submitting...</div>
    <div class="success-message">Submission successful!</div>
  </div>

  <div class="footer-info">
    <p>Powered and Developed By<br>
    <strong>Rakibul Islam Ratul</strong><br>
    <small>Sr. Manager, Central Governance, Metal Plus Ltd.</small></p>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

  <script>
    $(document).ready(function () {
      // Initialize Select2
      $('#siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown').select2({
        placeholder: 'Search and select...',
        allowClear: true
      });
      $('#operatorName, #selectOption, #siteAttend').select2({
           placeholder: 'Select...',
           allowClear: true
      });

      // --- Set Max Date/Time for datetime-local inputs ---
      function setMaxDateTime() {
          const now = new Date();
          // Format the date and time as YYYY-MM-DDTHH:MM
          const year = now.getFullYear();
          const month = (now.getMonth() + 1).toString().padStart(2, '0'); // Month is 0-indexed
          const day = now.getDate().toString().padStart(2, '0');
          const hours = now.getHours().toString().padStart(2, '0');
          const minutes = now.getMinutes().toString().padStart(2, '0');

          const maxDateTimeString = `${year}-${month}-${day}T${hours}:${minutes}`;

          // Apply the max attribute to all datetime-local inputs
          $('input[type="datetime-local"]').attr('max', maxDateTimeString);
          console.log("Max datetime set to:", maxDateTimeString);
      }

      // Call the function to set the max attribute when the page loads
      setMaxDateTime();

      // You might want to call this periodically if the user keeps the form open for a long time
      // setInterval(setMaxDateTime, 60000); // Update max every minute


      // Handle conditional field display based on Select Option
      // Also triggers validation for relevant fields
      $('#selectOption').change(function () {
        if ($(this).val() === 'Misscall TT') {
          $('#misscallTTFields').show();
          $('#pgRunFields').hide();
          // Clear and remove validation errors from PG Run fields when hidden
          $('#pgRunFields input').val('');
          $('#pgRunFields .error-message').text('');
          $('#pgRunFields input').removeClass('is-invalid');


        } else if ($(this).val() === 'PG Run') {
          $('#misscallTTFields').hide();
          $('#pgRunFields').show();
          // Clear and remove validation errors from Misscall TT fields when hidden
          $('#misscallTTFields select, #misscallTTFields input').val(null).trigger('change'); // Use val(null).trigger('change') for Select2
          $('#misscallTTFields .error-message').text('');
          $('#misscallTTFields input').removeClass('is-invalid');
           // Select2s need special handling for error class removal on their container
          $('#operatorName, #siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown, #selectOption, #siteAttend').each(function() {
               if ($(this).hasClass('select2-hidden-accessible')) {
                 $(this).next('.select2-container').find('.select2-selection--single').removeClass('is-invalid');
               }
           });
          $('#siteAttend').trigger('change'); // Ensure Site Attend DateTime is hidden


        } else {
          // Hide both if neither option is selected
          $('#misscallTTFields').hide();
          $('#pgRunFields').hide();
           // Clear all conditional fields and errors
          $('#misscallTTFields select, #misscallTTFields input').val(null).trigger('change');
          $('#pgRunFields input').val('');
          $('#misscallTTFields .error-message, #pgRunFields .error-message').text('');
          $('#misscallTTFields input').removeClass('is-invalid');
           // Select2s need special handling for error class removal on their container
           $('#operatorName, #siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown, #selectOption, #siteAttend').each(function() {
               if ($(this).hasClass('select2-hidden-accessible')) {
                 $(this).next('.select2-container').find('.select2-selection--single').removeClass('is-invalid');
               }
           });
           $('#siteAttend').trigger('change'); // Ensure Site Attend DateTime is hidden
        }
         // Trigger validation for selectOption itself
        validateField($(this).attr('id'));
         // Re-validate conditional date/time fields based on this selection
        validateConditionalDateTimeFields();
      });

      // Handle conditional field display based on Site Attend
       // Also triggers validation for relevant fields
      $('#siteAttend').change(function () {
        if ($(this).val() === 'YES') {
          $('#siteAttendDateTimeField').show();
        } else {
          $('#siteAttendDateTimeField').hide();
           $('#siteAttendDateTimeField input').val(''); // Clear date if field is hidden
            // Clear validation error for Site Attend DateTime when hidden
           $('#siteAttendDateTime-error').text('');
           $('#siteAttendDateTime').removeClass('is-invalid');
        }
        // Trigger validation for siteAttend itself and its dependent date field
         validateField($(this).attr('id'));
         // Only validate siteAttendDateTime if it's visible (or based on selectOption/siteAttend state)
         // validateField('siteAttendDateTime'); // This is handled in validateConditionalDateTimeFields now
         validateConditionalDateTimeFields(); // Trigger full validation on change
      });


      // Function to load data from CSV
      async function loadCSVData(file) {
        try {
           const response = await fetch(file);
           if (!response.ok) {
               throw new Error(`HTTP error! status: ${response.status}`);
           }
           const text = await response.text();
           const lines = text.split('\n').slice(1); // Skip header row
           return lines.map(line => line.trim()).filter(line => line); // Trim whitespace and remove empty lines
        } catch (error) {
           console.error("Error loading CSV data:", error);
           return []; // Return empty array on error
        }
      }

      // Function to populate dropdowns from CSV data
      async function populateDropdown(dropdownId, dataFile) {
        const dropdown = document.getElementById(dropdownId);
        // Add a default blank option for required fields with select2 allowClear
         $(dropdown).append('<option value=""></option>');

        const data = await loadCSVData(dataFile);
        data.forEach(item => {
          const option = document.createElement('option');
          option.value = item;
          option.textContent = item;
          dropdown.appendChild(option);
        });
         // Refresh select2 after populating
        $(`#${dropdownId}`).val(null).trigger('change'); // Set to blank and refresh Select2
      }

      // Populate dropdowns on page load
      populateDropdown('siteDropdown', 'data/sites.csv'); // Assuming data/sites.csv exists
      populateDropdown('pgOperatorDropdown', 'data/runners.csv'); // Assuming data/runners.csv exists
      populateDropdown('teamLeaderDropdown', 'data/runners.csv'); // Assuming data/runners.csv exists


      // Helper function to parse datetime-local string into a Date object (local time)
      function parseDateTimeLocal(datetimeStr) {
          if (!datetimeStr) return null;
          const [datePart, timePart] = datetimeStr.split('T');
          if (!datePart || !timePart) return null; // Basic check for valid format
          const [year, month, day] = datePart.split('-').map(Number);
          const [hour, minute] = timePart.split(':').map(Number);

          // Validate parts are numbers and within reasonable range
          if (isNaN(year) || isNaN(month) || isNaN(day) || isNaN(hour) || isNaN(minute)) return null;
          if (month < 1 || month > 12 || day < 1 || day > 31 || hour < 0 || hour > 23 || minute < 0 || minute > 59) return null;

          // Month is 0-indexed in Date constructor
          // Note: This creates a Date object in the browser's local timezone
          return new Date(year, month - 1, day, hour, minute);
      }

      // Helper function to display or clear error messages and apply invalid class
      function displayError(fieldId, message) {
          const errorSpan = $(`#${fieldId}-error`);
          const fieldElement = $(`#${fieldId}`); // The original input/select element

          if (!errorSpan.length) {
             console.error(`Error span not found for field: #${fieldId}-error`);
             // Continue without displaying error if span not found
             if (message) {
                 fieldElement.addClass('is-invalid');
                  // Special handling for Select2
                 if (fieldElement.hasClass('select2-hidden-accessible')) {
                   fieldElement.next('.select2-container').find('.select2-selection--single').addClass('is-invalid');
                 }
             } else {
                 fieldElement.removeClass('is-invalid');
                  if (fieldElement.hasClass('select2-hidden-accessible')) {
                   fieldElement.next('.select2-container').find('.select2-selection--single').removeClass('is-invalid');
                 }
             }
             return; // Exit if no error span
          }


          if (message) {
              errorSpan.text(message);
              // Apply invalid class to the original field AND the Select2 container if it's a Select2
              fieldElement.addClass('is-invalid');
              if (fieldElement.hasClass('select2-hidden-accessible')) {
                 // Select2 replaces the original select, apply class to its visible container
                 fieldElement.next('.select2-container').find('.select2-selection--single').addClass('is-invalid');
              }
          } else {
              errorSpan.text('');
              // Remove invalid class from the original field AND the Select2 container
              fieldElement.removeClass('is-invalid');
               if (fieldElement.hasClass('select2-hidden-accessible')) {
                 fieldElement.next('.select2-container').find('.select2-selection--single').removeClass('is-invalid');
               }
          }
      }

      // --- Real-time Validation Functions ---

      // Validate required text/select fields
      function validateField(fieldId) {
          const value = $(`#${fieldId}`).val();
           // Check for Select2 fields which might return null or '' depending on setup/placeholder
           // Select2 initialized fields will have a value property even if placeholder is shown,
           // but the *value* will be '' if the placeholder is selected.
           // For required Select2, we check if the value is empty string.
          if (!value) {
              displayError(fieldId, 'This field is mandatory.');
              return false; // Indicates validation failed
          } else {
              displayError(fieldId, ''); // Clear error
              return true; // Indicates validation passed
          }
      }

       // Validate conditional Date/Time fields based on selected option
       // This function handles Site Attend, Site Attend DateTime, and all PG Events validation
       function validateConditionalDateTimeFields() {
           const selectOption = $('#selectOption').val();
           const siteAttend = $('#siteAttend').val();

           // Clear previous conditional errors first for fields that might hide/show
           displayError('siteAttend', '');
           displayError('siteAttendDateTime', '');
           displayError('pgStart1', '');
           displayError('pgStop1', '');
           displayError('pgStart2', '');
           displayError('pgStop2', '');
           displayError('pgStart3', '');
           displayError('pgStop3', '');


           let allValid = true; // Track validity within this group
            const now = new Date(); // Get current time for future date comparison


           if (selectOption === 'Misscall TT') {
               // Site Attend is mandatory for Misscall TT
               if (!siteAttend) {
                   displayError('siteAttend', 'This field is mandatory for Misscall TT.');
                   allValid = false;
               } else if (siteAttend === 'YES') {
                   // Site Attend Date & Time is mandatory if Site Attend is YES
                   if (!$('#siteAttendDateTime').val()) { // Check raw value string
                       displayError('siteAttendDateTime', 'Date & Time is mandatory when Site Attend is YES.');
                       allValid = false;
                   } else {
                       // Validate date format if value exists
                       const siteAttendDateTime = parseDateTimeLocal($('#siteAttendDateTime').val());
                       if (!siteAttendDateTime) {
                            displayError('siteAttendDateTime', 'Invalid date format.');
                            allValid = false;
                       } else {
                           // Check if date is in the future (greater than current time)
                            if (siteAttendDateTime > now) {
                                displayError('siteAttendDateTime', 'Future date/time selection is not allowed.');
                                allValid = false;
                            }
                       }
                   }
               }
               // PG Run fields are not needed, errors cleared above when selectOption changes

           } else if (selectOption === 'PG Run') {
               const pgStart1Val = $('#pgStart1').val();
               const pgStop1Val = $('#pgStop1').val();
               const pgStart2Val = $('#pgStart2').val();
               const pgStop2Val = $('#pgStop2').val();
               const pgStart3Val = $('#pgStart3').val();
               const pgStop3Val = $('#pgStop3').val();

               const pgStart1 = parseDateTimeLocal(pgStart1Val);
               const pgStop1 = parseDateTimeLocal(pgStop1Val);
               const pgStart2 = parseDateTimeLocal(pgStart2Val);
               const pgStop2 = parseDateTimeLocal(pgStop2Val);
               const pgStart3 = parseDateTimeLocal(pgStart3Val);
               const pgStop3 = parseDateTimeLocal(pgStop3Val);


               // 1st Event is mandatory for PG Run
               if (!pgStart1Val || !pgStop1Val) {
                   if (!pgStart1Val) displayError('pgStart1', 'Mandatory for PG Run.');
                   if (!pgStop1Val) displayError('pgStop1', 'Mandatory for PG Run.');
                   allValid = false;
               } else {
                   // Validate 1st Event dates are valid and Stop > Start and not in future
                   if (!pgStart1) { displayError('pgStart1', 'Invalid format/value.'); allValid = false; }
                   if (!pgStop1) { displayError('pgStop1', 'Invalid format/value.'); allValid = false; }

                   if (pgStart1 && pgStop1) { // Only check order and future if both are valid dates
                       if (pgStop1 <= pgStart1) {
                           displayError('pgStop1', 'Must be after Start time.');
                           allValid = false;
                       }
                       if (pgStart1 > now) {
                           displayError('pgStart1', 'Future date/time not allowed.');
                           allValid = false;
                       }
                       if (pgStop1 > now) {
                            displayError('pgStop1', 'Future date/time not allowed.');
                            allValid = false;
                       }
                   } else if (pgStart1Val || pgStop1Val) { // If partially filled but dates are invalid
                        allValid = false; // Invalid format/value already flagged
                   }
               }

               // 2nd Event checks (if either field has a value)
               if (pgStart2Val || pgStop2Val) {
                    // Must fill both Start and Stop for 2nd event
                    if (!pgStart2Val || !pgStop2Val) {
                        if (!pgStart2Val) displayError('pgStart2', 'Both times mandatory if providing.');
                        if (!pgStop2Val) displayError('pgStop2', 'Both times mandatory if providing.');
                        allValid = false;
                    } else {
                         // Must have valid 1st event times if 2nd is filled
                         if (!pgStart1Val || !pgStop1Val) { // Check raw values
                            displayError('pgStart2', 'Requires 1st event times.');
                            displayError('pgStop2', 'Requires 1st event times.'); // Apply to both for clarity
                            allValid = false;
                         } else {
                             // Validate 2nd Event dates are valid and Stop > Start, Start > 1st Stop, and not in future
                             let currentEventValid = true; // Track validity within this event check
                             if (!pgStart2) { displayError('pgStart2', 'Invalid format/value.'); currentEventValid = false; allValid = false; }
                             if (!pgStop2) { displayError('pgStop2', 'Invalid format/value.'); currentEventValid = false; allValid = false; }

                             if (currentEventValid) { // Only check order and future if both dates are valid
                                 if (pgStop2 <= pgStart2) {
                                     displayError('pgStop2', 'Must be after Start time.');
                                     allValid = false;
                                 }
                                  // Need valid pgStop1 for this check (and it must not have a future error itself)
                                 if (pgStop1 && pgStart2 <= pgStop1) { // Check pgStop1 validity again before comparison
                                     displayError('pgStart2', 'Must be after 1st Stop time.');
                                     allValid = false;
                                 }
                                 if (pgStart2 > now) {
                                     displayError('pgStart2', 'Future date/time not allowed.');
                                     allValid = false;
                                 }
                                 if (pgStop2 > now) {
                                      displayError('pgStop2', 'Future date/time not allowed.');
                                      allValid = false;
                                 }
                             } else { // If partially filled and dates are invalid
                                  allValid = false; // Already set by invalid format checks, but good practice
                             }
                         }
                    }
               }

               // 3rd Event checks (if either field has a value)
               if (pgStart3Val || pgStop3Val) {
                   // Must fill both Start and Stop for 3rd event
                   if (!pgStart3Val || !pgStop3Val) {
                       if (!pgStart3Val) displayError('pgStart3', 'Both times mandatory if providing.');
                       if (!pgStop3Val) displayError('pgStop3', 'Both times mandatory if providing.');
                       allValid = false;
                   } else {
                       // Must have valid 1st AND 2nd event times if 3rd is filled
                       if (!pgStart1Val || !pgStop1Val || !pgStart2Val || !pgStop2Val) { // Check raw values
                           displayError('pgStart3', 'Requires 1st & 2nd event times.');
                           displayError('pgStop3', 'Requires 1st & 2nd event times.'); // Apply to both
                           allValid = false;
                       } else {
                            // Validate 3rd Event dates are valid and Stop > Start and Start > 2nd Stop and not in future
                            let currentEventValid = true; // Track validity within this event check
                            if (!pgStart3) { displayError('pgStart3', 'Invalid format/value.'); currentEventValid = false; allValid = false; }
                            if (!pgStop3) { displayError('pgStop3', 'Invalid format/value.'); currentEventValid = false; allValid = false; }

                            if (currentEventValid) { // Only check order and future if both dates are valid
                                if (pgStop3 <= pgStart3) {
                                    displayError('pgStop3', 'Must be after Start time.');
                                    allValid = false;
                                }
                                // Need valid pgStop2 for this check (and it must not have a future error itself)
                                if (pgStop2 && pgStart3 <= pgStop2) { // Check pgStop2 validity before comparison
                                    displayError('pgStart3', 'Must be after 2nd Stop time.');
                                    allValid = false;
                                }
                                if (pgStart3 > now) {
                                     displayError('pgStart3', 'Future date/time not allowed.');
                                     allValid = false;
                                }
                                if (pgStop3 > now) {
                                     displayError('pgStop3', 'Future date/time not allowed.');
                                     allValid = false;
                                }
                            } else { // If partially filled and dates are invalid
                                allValid = false; // Already set, but good practice
                            }
                       }
                   }
               }
           }
           // If neither option is selected, no conditional validation applies, fields should be empty and hidden
           // This case is implicitly handled by the initial display/clearing logic

           return allValid; // Return overall validity for conditional fields
       }


      // --- Event Listeners for Real-time Validation ---

      // Basic required fields validation on blur
      $('#ttNumber').on('blur', function() { validateField('ttNumber'); });

       // Select2 fields validation on change (Select2 triggers 'change' on the original select)
       $('#operatorName, #siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown, #selectOption, #siteAttend').on('change', function() {
            const fieldId = $(this).attr('id');
            // Validate required/basic rule only if the field is currently visible
            // Note: Select2 hidden fields will still trigger change if value is set programmatically (like .val(null).trigger('change'))
            // We only want to show errors for *visible* mandatory fields
            if ($(this).is(':visible') || $(this).next('.select2-container').is(':visible')) {
                 // Check if the original select element itself is visible or if its Select2 container is visible
                 // This is a more robust check for Select2 visibility
                 if ($(this).is(':visible') || ($(this).next('.select2-container').length && $(this).next('.select2-container').is(':visible'))) {
                     validateField(fieldId);
                 } else {
                     displayError(fieldId, ''); // Ensure error is cleared if field becomes hidden
                 }
            } else {
                displayError(fieldId, ''); // Ensure error is cleared if field is not visible
            }


            // Trigger re-validation for conditional date/time fields if selectOption or SiteAttend changed
            if (fieldId === 'selectOption' || fieldId === 'siteAttend') {
                 validateConditionalDateTimeFields();
            }
       });

      // Conditional date/time fields validation on change/blur
      $('#siteAttendDateTime, #pgStart1, #pgStop1, #pgStart2, #pgStop2, #pgStart3, #pgStop3').on('change blur', function() {
          // Only validate if the date/time field's parent container is visible
          if ($(this).closest('.card').is(':visible') || $(this).closest('.event-card').is(':visible')) {
             validateConditionalDateTimeFields(); // Re-validate all conditional date fields
          } else {
            // If the field is hidden, clear its specific error
            displayError($(this).attr('id'), '');
          }
      });


      // --- Form Submission Handler ---
      $('#pgForm').submit(function (event) {
        event.preventDefault(); // Prevent default submission initially

        // Perform final validation on ALL fields before submitting
        let formIsValid = true;

        // Validate basic required fields that are always visible
        formIsValid = validateField('ttNumber') && formIsValid;
        // Validate Select2 fields - only if visible (handled in validateField call below)
        formIsValid = validateField('operatorName') && formIsValid;
        formIsValid = validateField('siteDropdown') && formIsValid;
        formIsValid = validateField('pgOperatorDropdown') && formIsValid;
        formIsValid = validateField('teamLeaderDropdown') && formIsValid;
        formIsValid = validateField('selectOption') && formIsValid;


        // Validate conditional fields (including PG events and Site Attend)
        // This function handles their visibility checks internally
        formIsValid = validateConditionalDateTimeFields() && formIsValid;


        // If any validation failed, stop submission
        if (!formIsValid) {
           $('.loading').hide(); // Hide loading if it was shown
           // You might want to scroll to the first error or highlight summary here
           alert('Please fix the errors in the form before submitting.'); // Simple alert for submission failure
           return;
        }

        // If validation passes, proceed with submission
        const formData = new FormData(this);
        const jsonData = {};
        const expectedFields = [
           'ttNumber', 'operatorName', 'site', 'pgOperator', 'teamLeader',
           'selectOption', 'siteAttend', 'siteAttendDateTime',
           'pgStart1', 'pgStop1', 'pgStart2', 'pgStop2', 'pgStart3', 'pgStop3'
         ];
         expectedFields.forEach(field => {
           // Collect values - Select2 .val() should work correctly for selected option
           // For text/date inputs, .val() is fine
            if (field === 'site') {
                 jsonData[field] = $('#siteDropdown').val() || '';
            } else if (field === 'pgOperator') {
                 jsonData[field] = $('#pgOperatorDropdown').val() || '';
            } else if (field === 'teamLeader') {
                 jsonData[field] = $('#teamLeaderDropdown').val() || '';
            } else if (field === 'operatorName') {
                 jsonData[field] = $('#operatorName').val() || '';
            }
            else {
                jsonData[field] = $(`#${field}`).val() || '';
            }
         });


        jsonData.timestamp = new Date().toISOString(); // Add timestamp in ISO format

        console.log("Data being sent:", JSON.stringify(jsonData, null, 2)); // Keep the log
        $('.loading').show(); // Show loading indicator

        // Send data to Google Apps Script Web App (or Netlify proxy)
        fetch('/.netlify/functions/proxy', { // Or your direct Apps Script Web App URL
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(jsonData)
        })
        .then(response => {
            console.log("Fetch Response Status:", response.status); // Log status
            console.log("Fetch Response OK:", response.ok);     // Log response.ok
            console.log("Fetch Response Headers:", Array.from(response.headers.entries())); // Log headers

            if (!response.ok) {
                // This block should only be for non-200 statuses, but we'll log body just in case
                return response.text().then(text => {
                     console.error(`HTTP error! status: ${response.status}, body: ${text}`); // Log the body on error status
                     throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }

            // If response is OK (status 200-299), check content type and parse as JSON
            const contentType = response.headers.get("content-type");
             // Also accept 'text/plain' as Apps Script sometimes returns this with JSON content
            if (contentType && (contentType.includes("application/json") || contentType.includes("text/plain"))) {
                 return response.text().then(text => {
                      try {
                         // If the text is empty, parsing will fail, which is expected if the script returns nothing
                         if (!text) {
                             throw new Error("Received empty response body from server.");
                         }
                         return JSON.parse(text); // Try to parse the text as JSON
                      } catch (jsonError) {
                         console.error('Failed to parse response as JSON:', jsonError, 'Response text:', text);
                         // Throw an error that will be caught by the .catch block
                         throw new Error('Failed to parse JSON response from server.');
                      }
                 });
            } else {
                 // If content type is unexpected, read as text and throw an error
                 return response.text().then(text => {
                      console.error('Received unexpected content type from server:', contentType, 'Response text:', text);
                      throw new Error('Received unexpected response from server. Check Apps Script logs.');
                 });
            }
        })
        .then(result => {
          $('.loading').hide();
          console.log("Fetch Response JSON Result:", result); // Log the parsed JSON result

          // Check if result is a valid object and has the expected success structure
          if (result && typeof result === 'object' && result.result === 'success') {
              $('.success-message').show();
              $('#pgForm')[0].reset();
              // Reset select2 dropdowns and trigger change
              $('#operatorName, #selectOption, #siteAttend').val(null).trigger('change');
               $('#siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown').val(null).trigger('change');

               // Manually reset Select2 search input visually if needed
               $('.select2-selection__rendered').empty().append('<span class="select2-selection__placeholder">Select...</span>');


              // Trigger change on conditional fields to hide them and clear their values
              $('#selectOption').trigger('change'); // This also triggers siteAttend change if needed

              // Clear all validation errors after successful submission
              $('.error-message').text('');
              $('input, select').removeClass('is-invalid');
              $('.select2-container .select2-selection--single').removeClass('is-invalid');


              setTimeout(() => { $('.success-message').hide(); }, 3000);
          } else {
               // Handles cases where response was OK but the JSON body didn't have {result: 'success'} or was unexpected
               // Log the unexpected result for debugging
               console.error('Submission result was not successful:', result);
               alert('Submission failed: ' + (result && result.error ? result.error : 'Unknown response format from server or empty response.'));
          }
        })
        .catch(error => {
          $('.loading').hide();
          // This catches any errors thrown in the .then chain (network errors, JSON parsing errors, errors we threw)
          alert('Submission failed: ' + error.message); // This is the alert message
          console.error('Fetch Error:', error); // Log the full error object to console
        });
      });


       // --- Initial Setup ---
       // Trigger change on load for selectOption to set initial display state
       // This also cascades to siteAttend change if Misscall TT is default selected
       $('#selectOption').trigger('change');

       // Trigger blur on initial required fields to show errors on load if empty (optional, but good for mandatory fields)
       $('#ttNumber').trigger('blur');


    }); // End of $(document).ready

  </script>

</body>
</html>