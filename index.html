<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport <label for="ttNumber">TT Number:</label>
        <input type="text" id="ttNumber" name="ttNumber" required />
        <span class="error-message" id="ttNumberError"></span>

        <label for="operatorName">Operator Name:</label>
        <select id="operatorName" name="operatorName" required>
          <option value selected>Select an operator</option>
          <option value="GP">GP</option>
          <option value="BL">BL</option>
          <option value="ROBI">ROBI</option>
        </select>
        <span class="error-message" id="operatorNameError"></span>

        <label for="siteDropdown">Select Site:</label>
        <select id="siteDropdown" name="site" required></select>
        <span class="error-message" id="siteDropdownError"></span>
      </div>

      <div class="card">
        <label for="pgOperatorDropdown">Select PG Operator Name:</label>
        <select id="pgOperatorDropdown" name="pgOperator" required></select>
        <span class="error-message" id="pgOperatorDropdownError"></span>

        <label for="teamLeaderDropdown">Select Team Leader Name:</label>
        <select id="teamLeaderDropdown" name="teamLeader" required></select>
        <span class="error-message" id="teamLeaderDropdownError"></span>
      </div>

      <div class="card">
        <label for="selectOption">Select Option:</label>
        <select id="selectOption" name="selectOption" required>
          <option value="" disabled selected>Select an option</option>
          <option value="Misscall TT">Misscall TT</option>
          <option value="PG Run">PG Run</option>
        </select>
        <span class="error-message" id="selectOptionError"></span>
      </div>
      <div id="misscallTTFields" style="display: none;" class="card">
        <label for="siteAttend">Site Attend:</label>
        <select id="siteAttend" name="siteAttend">
          <option value="" disabled selected>Select an option</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
        </select>
        <span class="error-message" id="siteAttendError"></span>

        <div id="siteAttendDateTimeField" style="display: none;">
          <label for="siteAttendDateTime">Site Attend Date & Time:</label>
          <input type="datetime-local" id="siteAttendDateTime" name="siteAttendDateTime" />
          <span class="error-message" id="siteAttendDateTimeError"></span>
        </div>
      </div>

      <div id="pgRunFields" style="display: none;">
        <div class="event-card">
          <h3>1st Event</h3>
          <label for="pgStart1">PG Start Date & Time:</label>
          <input type="datetime-local" id="pgStart1" name="pgStart1" />
          <span class="error-message" id="pgStart1Error"></span>

          <label for="pgStop1">PG Stop Date & Time:</label>
          <input type="datetime-local" id="pgStop1" name="pgStop1" />
          <span class="error-message" id="pgStop1Error"></span>
        </div>

        <div class="event-card">
          <h3>2nd Event</h3>
          <label for="pgStart2">PG Start Date & Time:</label>
          <input type="datetime-local" id="pgStart2" name="pgStart2" />
          <span class="error-message" id="pgStart2Error"></span>

          <label for="pgStop2">PG Stop Date & Time:</label>
          <input type="datetime-local" id="pgStop2" name="pgStop2" />
          <span class="error-message" id="pgStop2Error"></span>
        </div>

        <div class="event-card">
          <h3>3rd Event</h3>
          <label for="pgStart3">PG Start Date & Time:</label>
          <input type="datetime-local" id="pgStart3" name="pgStart3" />
          <span class="error-message" id="pgStart3Error"></span>

          <label for="pgStop3">PG Stop Date & Time:</label>
          <input type="datetime-local" id="pgStop3" name="pgStop3" />
          <span class="error-message" id="pgStop3Error"></span>
        </div>
      </div>

      <button type="submit">Submit</button>
    </form>

    <div class="loading">Submitting...</div>
    <div class="success-message">Submission successful!</div>
  </div>

  <div class="footer-info">
    <p>Powered and Developed By<br>
    <strong>Rakibul Islam Ratul</strong><br>
    <small>Sr. Manager, Central Governance, Metal Plus Ltd.</small></p>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script>
    $(document).ready(function () {
      function showError(id, message) {
        $(`#${id}`).addClass('invalid');
        $(`#${id}Error`).text(message).show();
      }

      function hideError(id) {
        $(`#${id}`).removeClass('invalid');
        $(`#${id}Error`).hide();
      }

      function validateField(id, message) {
        const value = $(`#${id}`).val();
        if (!value) {
          showError(id, message);
          return false;
        } else {
          hideError(id);
          return true;
        }
      }

      function validateDateOrder(startId, stopId, label) {
        const start = new Date($(`#${startId}`).val());
        const stop = new Date($(`#${stopId}`).val());
        if ($(`#${startId}`).val() && $(`#${stopId}`).val() && stop <= start) {
          showError(stopId, `${label} Stop must be after Start`);
          return false;
        } else {
          hideError(stopId);
          return true;
        }
      }

      function validateForm() {
        let valid = true;
        valid &= validateField('ttNumber', 'TT Number is required.');
        valid &= validateField('operatorName', 'Operator Name is required.');
        valid &= validateField('siteDropdown', 'Site is required.');
        valid &= validateField('pgOperatorDropdown', 'PG Operator is required.');
        valid &= validateField('teamLeaderDropdown', 'Team Leader is required.');
        valid &= validateField('selectOption', 'Select Option is required.');

        const option = $('#selectOption').val();
        if (option === 'Misscall TT') {
          valid &= validateField('siteAttend', 'Site Attend is required.');
          if ($('#siteAttend').val() === 'YES') {
            valid &= validateField('siteAttendDateTime', 'Date & Time is required.');
          }
        }

        if (option === 'PG Run') {
          valid &= validateField('pgStart1', 'Start time is required.');
          valid &= validateField('pgStop1', 'Stop time is required.');
          valid &= validateDateOrder('pgStart1', 'pgStop1', '1st Event');

          if ($('#pgStart2').val() || $('#pgStop2').val()) {
            valid &= validateField('pgStart2', 'Start time is required.');
            valid &= validateField('pgStop2', 'Stop time is required.');
            valid &= validateDateOrder('pgStart2', 'pgStop2', '2nd Event');
          }

          if ($('#pgStart3').val() || $('#pgStop3').val()) {
            valid &= validateField('pgStart3', 'Start time is required.');
            valid &= validateField('pgStop3', 'Stop time is required.');
            valid &= validateDateOrder('pgStart3', 'pgStop3', '3rd Event');
          }
        }

        return !!valid;
      }

      $('#pgForm').on('submit', function (e) {
        e.preventDefault();
        if (validateForm()) {
          $('.loading').show();
          const formData = $(this).serializeArray();
          const jsonData = {};
          formData.forEach(item => jsonData[item.name] = item.value);

          fetch('/.netlify/functions/proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(jsonData)
          })
          .then(res => res.json())
          .then(result => {
            $('.loading').hide();
            if (result.result === 'success') {
              $('.success-message').show();
              setTimeout(() => $('.success-message').hide(), 3000);
              $('#pgForm')[0].reset();
              $('select').val('').trigger('change');
              $('.error-message').hide();
              $('.invalid').removeClass('invalid');
            } else {
              alert('Submission failed: ' + (result.error || 'Unknown error from server'));
            }
          })
          .catch(err => {
            $('.loading').hide();
            alert('Submission failed: ' + err.message);
          });
        }
      });

      $('#selectOption').on('change', function () {
        const val = $(this).val();
        if (val === 'Misscall TT') {
          $('#misscallTTFields').show();
          $('#pgRunFields').hide();
        } else if (val === 'PG Run') {
          $('#misscallTTFields').hide();
          $('#pgRunFields').show();
        } else {
          $('#misscallTTFields, #pgRunFields').hide();
        }
      });

      $('#siteAttend').on('change', function () {
        if ($(this).val() === 'YES') {
          $('#siteAttendDateTimeField').show();
        } else {
          $('#siteAttendDateTimeField').hide();
        }
      });

      $('#siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown').select2({ placeholder: 'Search and select...', allowClear: true });
      $('#operatorName, #selectOption, #siteAttend').select2({ placeholder: 'Select...', allowClear: true });
    });
  </script>
</body>
</html>
