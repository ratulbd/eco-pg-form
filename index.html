<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E.CO PG Run Data Collection Form</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>E.CO PG Run Data Collection Form</h2>
    <form id="pgForm">
      <div class="card">
        <label for="ttNumber">TT Number:</label>
        <input type="text" id="ttNumber" name="ttNumber" required />

        <label for="operatorName">Operator Name:</label>
        <select id="operatorName" name="operatorName" required>
          <option value="" disabled selected>Select an operator</option>
          <option value="GP">GP</option>
          <option value="BL">BL</option>
          <option value="ROBI">ROBI</option>
        </select>

        <label for="siteDropdown">Select Site:</label>
        <select id="siteDropdown" name="site" required></select>
      </div>

      <div class="card">
        <label for="pgOperatorDropdown">Select PG Operator Name:</label>
        <select id="pgOperatorDropdown" name="pgOperator" required></select>

        <label for="teamLeaderDropdown">Select Team Leader Name:</label>
        <select id="teamLeaderDropdown" name="teamLeader" required></select>
      </div>

      <div class="card">
        <label for="selectOption">Select Option:</label>
        <select id="selectOption" name="selectOption" required>
          <option value="" disabled selected>Select an option</option>
          <option value="Misscall TT">Misscall TT</option>
          <option value="PG Run">PG Run</option>
        </select>
      </div>

      <div id="misscallTTFields" style="display: none;" class="card">
        <label for="siteAttend">Site Attend:</label>
        <select id="siteAttend" name="siteAttend">
          <option value="" disabled selected>Select an option</option>
          <option value="YES">YES</option>
          <option value="NO">NO</option>
        </select>

        <div id="siteAttendDateTimeField" style="display: none;">
          <label for="siteAttendDateTime">Site Attend Date & Time:</label>
          <input type="datetime-local" id="siteAttendDateTime" name="siteAttendDateTime" />
        </div>
      </div>

      <div id="pgRunFields" style="display: none;">
        <div class="event-card">
          <h3>1st Event</h3>
          <label for="pgStart1">PG Start Date & Time:</label>
          <input type="datetime-local" id="pgStart1" name="pgStart1" required />
          <label for="pgStop1">PG Stop Date & Time:</label>
          <input type="datetime-local" id="pgStop1" name="pgStop1" required />
        </div>

        <div class="event-card">
          <h3>2nd Event</h3>
          <label for="pgStart2">PG Start Date & Time:</label>
          <input type="datetime-local" id="pgStart2" name="pgStart2" />
          <label for="pgStop2">PG Stop Date & Time:</label>
          <input type="datetime-local" id="pgStop2" name="pgStop2" />
        </div>

        <div class="event-card">
          <h3>3rd Event</h3>
          <label for="pgStart3">PG Start Date & Time:</label>
          <input type="datetime-local" id="pgStart3" name="pgStart3" />
          <label for="pgStop3">PG Stop Date & Time:</label>
          <input type="datetime-local" id="pgStop3" name="pgStop3" />
        </div>
      </div>

      <button type="submit">Submit</button>
    </form>
    <div class="loading">Submitting...</div>
    <div class="success-message">Submission successful!</div>
  </div>

 <!-- Only the script section is shown here for brevity -->
<!-- Inside <script> tag at the bottom of the file -->
<script>
$(document).ready(function () {
  $('#siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown').select2({
    placeholder: 'Search and select...',
    allowClear: true
  });

  $('#selectOption').change(function () {
    if ($(this).val() === 'Misscall TT') {
      $('#misscallTTFields').show();
      $('#pgRunFields').hide();
    } else if ($(this).val() === 'PG Run') {
      $('#misscallTTFields').hide();
      $('#pgRunFields').show();
    } else {
      $('#misscallTTFields').hide();
      $('#pgRunFields').hide();
    }
  });

  $('#siteAttend').change(function () {
    if ($(this).val() === 'YES') {
      $('#siteAttendDateTimeField').show();
    } else {
      $('#siteAttendDateTimeField').hide();
    }
  });

  async function loadCSVData(file) {
    const response = await fetch(file);
    const text = await response.text();
    const lines = text.split('\n').slice(1);
    return lines.map(line => line.trim()).filter(line => line);
  }

  async function populateDropdown(dropdownId, dataFile) {
    const dropdown = document.getElementById(dropdownId);
    const data = await loadCSVData(dataFile);
    data.forEach(item => {
      const option = document.createElement('option');
      option.value = item;
      option.textContent = item;
      dropdown.appendChild(option);
    });
    $(`#${dropdownId}`).select2({ placeholder: 'Search and select...', allowClear: true });
  }

  populateDropdown('siteDropdown', 'data/sites.csv');
  populateDropdown('pgOperatorDropdown', 'data/runners.csv');
  populateDropdown('teamLeaderDropdown', 'data/runners.csv');

  $('#pgForm').submit(function (event) {
    event.preventDefault();
    const formData = new FormData(this);

    // ✅ FIXED: Ensure all expected fields are included, even if empty
    const expectedFields = [
      'ttNumber', 'operatorName', 'site', 'pgOperator', 'teamLeader',
      'selectOption', 'siteAttend', 'siteAttendDateTime',
      'pgStart1', 'pgStop1', 'pgStart2', 'pgStop2', 'pgStart3', 'pgStop3'
    ];

    const jsonData = {};
    expectedFields.forEach(field => {
      jsonData[field] = formData.get(field) || ''; // ✅ FIXED: Correct fallback for empty fields
    });

    jsonData.timestamp = new Date().toISOString(); // ✅ Timestamp added

  console.log("Data being sent:", JSON.stringify(jsonData, null, 2));

    $('.loading').show();
    fetch('/.netlify/functions/proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(jsonData)
    })
    .then(response => response.json())
    .then(result => {
      $('.loading').hide();
      $('.success-message').show();
      $('#pgForm')[0].reset();
      $('#operatorName, #selectOption, #siteAttend, #siteDropdown, #pgOperatorDropdown, #teamLeaderDropdown').val(null).trigger('change.select2');
      $('#selectOption').trigger('change');
      $('#siteAttend').trigger('change');
      setTimeout(() => { $('.success-message').hide(); }, 3000);
    })
    .catch(error => {
      $('.loading').hide();
      alert('Submission failed: ' + error.message);
    });
  });
});
</script>

 </div> <div class="footer-info">
    <p>Powered and Developed By<br>
    <strong>Rakibul Islam Ratul</strong><br>
    <small>Sr. Manager, Central Governance, Metal Plus Ltd.</small></p>
  </div>

</body>
</html>
